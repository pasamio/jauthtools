<html>
	<head>
		<title>Kerberos Single Sign on with Joomla or other PHP apps</title>
	</head>

	<body>
		<h1>Kerberos Single Sign on with Joomla or other PHP apps</h1><hr>
<p>This document covers configuring Kerberos Single Signon basics for Joomla. This document assumes that you have configured Kerberos properly, for example by following the <a href="kerberos_for_sles9.htm">Kerberos for SLES9</a> document.</p>


Due to the nature of Joomla (and other web apps), it has a large number of support documents (Javascript, CSS, images) on the server that need to be transferred. If you are using the base files from the Kerberos for SLES9 document, then you will fnid that Joomla will trigger a password dialog. This document explains how to solve this problem.<br />
<br />
Step 1: Altering the .htaccess file<br />
By limiting the requests to only PHP documents, we secure the executable point. This could be expanded to Word or Excel, but should ignore images for obvious reasons. This will prevent access to the system via the standard means, hopefully obscuring files that might be within the system. Using the below .htaccess file:<br />
<br />
<span style="font-family: courier new,courier,monospace;">&lt;FilesMatch &quot;\.php$&quot;&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthType Kerberos</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthName &quot;Enter your Novell Login&quot;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KrbMethodNegotiate On</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KrbAuthRealms SITE1.PASAMIO.HOMELINUX.NET</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KrbSaveCredentials on</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KrbMethodK5Passwd On</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KrbServiceName HTTP</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require valid-user</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&lt;/FilesMatch&gt;</span><br />
<br />
This sets up Kerberos authentication for all .php documents, this also means .htm and .html documents are ignored, this useful because of a flaw which appears to exist with this method. When directly accessing the file (e.g. http://fallenwall.pasamio.homelinux.net/~pasamio/mos-453-cvs-170805/index.php), the single sign-on system kicks in and is automatic. When the default document handler is invoked (e.g. http://fallenwall.pasamio.homelinux.net/~pasamio/mos-453-cvs-170805/) and index.php is the only option, the system will present with an Authorization failure. This is due to the Kerberos back end falsely detecting a Replay attack because the two requests are passed through it at the same time (and thus are technically a replay). Introducing a secondary page called index.html takes precendence over the index.php file and is used as the default document. As Kerberos is not enabled for this file, it doesn't suffer from the replay issue. A simply crafted file below also provides a small message for those who may not have single sign on configured properly in IE:<br />
<br />
<span style="font-family: courier new,courier,monospace;">&lt;html&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;head&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;title&gt;Automated Signon System&lt;/title&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=index.php&quot;&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/head&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;body&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;p align=&quot;center&quot;&gt;Please wait while the automated signon system intializes for this application...&lt;br&gt;If you are asked for a password, please enter your Novell login.</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/body&gt;</span><br style="font-family: courier new,courier,monospace;" /><span style="font-family: courier new,courier,monospace;">&lt;/html&gt;</span><br />
<br />
This simple file needs to be placed anywhere the index.php document is to override it. If the document doesn't properly override, search for the DirectoryIndex directive in the global configuration and ensure that index.html is ahead of index.php in this list. You may need to reboot Apache. After this, the single sign on should work fine.<br />
<br />
<span style="font-weight: bold;">Why only PHP files?</span><br />
Simple fact is that PHP files are the only ones that we can use to check if the user is actually allowed access to the system. Since Kerberos is executed at the Apache layer, it is run before any PHP scripts are initialized (and before checks to see if the file exist are done). From there a server variable is passed and the PHP scripts then use this to verify that the user is valid on that system.<br />

</body>
</html>


